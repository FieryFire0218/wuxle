<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Wuxle - Guess the Novel</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <h1>ðŸ“š Wuxle</h1>
  <p>Guess the WuxiaWorld novel of the day!</p>

  <input type="text" id="guessInput" placeholder="Enter novel title..." list="novelOptions">
  <datalist id="novelOptions">
    {% for title in novels %}
      <option value="{{ title }}">
    {% endfor %}
  </datalist>
  <button onclick="submitGuess()">Guess</button>

  <div id="results"></div>

  <script>
    let hasGivenUp = false;
    async function submitGuess() {
      if (hasGivenUp) {
        document.getElementById("results").innerHTML += `<p style="color:red">Game over. You already gave up.</p>`;
        return;
      }
      const inputEl = document.getElementById("guessInput");
      const title = inputEl.value;
      const res = await fetch("/guess", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({title})
      });
      const data = await res.json();

      let resultsDiv = document.getElementById("results");
      if (data.error) {
        resultsDiv.innerHTML += `<p style="color:red">${data.error}</p>`;
        // Clear the input field
        inputEl.value = "";
        inputEl.focus();
        return;
      }

      if (data.title === "ðŸŽ‰ Correct!") {
        resultsDiv.innerHTML += `<p>ðŸŽ‰ You guessed it! The novel was <b>${title}</b>.</p>`;
        } else {
        const genres = data.genres;
        resultsDiv.innerHTML += `<p>Guess: <b>${title}</b><br>
            Author: ${data.author} | Translator: ${data.translator}<br>
            Genres: ${genres.summary} (Matched: ${genres.matched.join(", ")})<br>
            Rating: ${data.rating.summary} | Chapters: ${data.chapters}</p>`;
        }
        // Clear the input field
        inputEl.value = "";
        inputEl.focus();
    }

    function renderStars(v) {
      if (v == null) return "";
      const num = Number(v);
      if (!isFinite(num)) return "";
      // Normalize to 0â€“5
      let r5 = num;
      if (num > 10) r5 = num / 20;      
      else if (num > 5) r5 = num / 2;  
      r5 = Math.max(0, Math.min(5, Math.round(r5 * 2) / 2));
      const full = Math.floor(r5);
      const half = (r5 - full) >= 0.5 ? 1 : 0;
      return "â˜…".repeat(full) + (half ? "Â½" : "");
    }
  </script>
  
  <button onclick="revealAnswer()">Give Up</button>

  <script>
    async function revealAnswer() {
        const res = await fetch("/answer");
        const ans = await res.json();
        document.getElementById("results").innerHTML += `
        <p>ðŸ’¡ The novel was <b>${ans.title}</b> by ${ans.author}<br>
        Translator: ${ans.translator}<br>
        Genres: ${ans.genres.join(", ")}<br>
        Rating: ${renderStars(ans.rating5 ?? ans.rating)} | Chapters: ${ans.chapters}</p>`;

        hasGivenUp = true;
        const inputEl = document.getElementById("guessInput");
        const guessBtn = document.getElementById("guessBtn");
        inputEl.disabled = true;
        guessBtn.disabled = true;
      }
  </script>

</body>
</html>
